name: AI Code Review

on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches-ignore:
      - main

jobs:
  code_review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run AI Code Review
      id: review_step
      run: |
        git fetch origin
        if git rev-parse --verify origin/main > /dev/null 2>&1; then
          git diff --name-only origin/main...HEAD > changed_files.txt
        else
          git ls-files > changed_files.txt
        fi
        python .github/scripts/review_code.py > review_output.txt || echo "Python script failed"
        review=$(cat review_output.txt || echo "No output generated")
        echo "review=$review" >> $GITHUB_ENV

    - name: Post review as a comment
      if: github.event_name == 'pull_request'
      run: |
        response=$(curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{\"body\": \"${{ env.review }}\"}" \
          https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments)
        echo "Response: $response"

