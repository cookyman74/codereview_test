name: AI Code Review

on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches-ignore:
      - main

jobs:
  code_review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run AI Code Review
      id: review_step
      run: |
        git fetch origin

        if git merge-base --is-ancestor origin/main HEAD; then
          git diff --name-only origin/main...HEAD > changed_files.txt
        else
          echo "No common ancestor, treating as first commit" > changed_files.txt
          git ls-files >> changed_files.txt
        fi

        # Python 스크립트를 실행하여 리뷰를 생성한 후, 결과를 review_output.txt 파일에 저장
        python .github/scripts/review_code.py > review_output.txt || echo "Python script failed"
    
    - name: Post review as a comment
      if: github.event_name == 'pull_request'
      run: |
        # 리뷰 결과를 review_output.txt에서 읽어서 GitHub PR에 코멘트로 남김
        review=$(cat review_output.txt)
        response=$(curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{\"body\": \"$review\"}" \
          https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments)
        echo "Response: $response"

